name: 'Configure GitHub CLI'
description: 'A template for building composite actions.'
# Ref: https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
author: 'rwaight'
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#branding
branding:
  icon: 'edit'
  color: 'blue'
  # Ref: https://haya14busa.github.io/github-action-brandings/
  # fork: https://github.com/rwaight/github-action-brandings

# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#inputs
inputs:
  account-type:
    description: 'The type of account to use, either `bot` or `user`.'
    required: true
    #default: 'bot'
  gh-app-key:
    description: 'The GitHub App Key used to authenticate to the GitHub CLI.'
    required: false
    default: ${{ github.token }}
  gh-token:
    description: 'GITHUB_TOKEN or a `repo` scoped Personal Access Token (PAT) used to authenticate to the GitHub CLI.'
    required: false
    default: ${{ github.token }}
  verbose:
    description: 'Determine if the action should run verbose tasks, defaults to false.'
    required: false
    default: 'false'

# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#outputs-for-composite-actions
outputs:
  user-id:
    description: "The ID of the authenticated GitHub user."
    value: ${{ steps.gh-user-info.outputs.user-id }}
  user-login:
    description: "The login of the authenticated GitHub user."
    value: ${{ steps.gh-user-info.outputs.user-login }}
  user-name:
    description: "The name of the authenticated GitHub user."
    value: ${{ steps.gh-user-info.outputs.user-name }}
  user-type:
    description: "The type of the authenticated GitHub user."
    value: ${{ steps.gh-user-info.outputs.user-type }}
  user-email:
    description: "The email of the authenticated GitHub user."
    value: ${{ steps.gh-user-info.outputs.user-email }}
  user-committer:
    description: "The committer information for the authenticated GitHub user."
    value: ${{ steps.gh-user-info.outputs.user-committer }}

# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#runs-for-composite-actions
runs:
  using: "composite"
  steps:

    - name: Validate that the runner OS is Linux
      if: ${{ runner.os != 'Linux' }}
      # https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#setting-an-error-message
      shell: bash
      run: |
        echo "::error title=â›” error hint::This action supports Linux only"
        exit 1


    - name: Greet the triggering_actor
      if: inputs.verbose=='true'
      shell: bash
      run: echo Hello ${{ github.triggering_actor }}, the verbose variable is set to true.


    - name: Verbose | Print the inputs
      if: inputs.verbose=='true'
      id: verbose-print-inputs
      shell: bash
      run: | 
        ## Print the inputs if inputs.verbose=='true'
        ## the double number signs below are for line spacing and readability only
        ##
        echo "gh-token SHOULD BE MASKED, but is set to ${{ inputs.gh-token }} "
        echo "my-example-input1 is set to ${{ inputs.my-example-input1 }} "
        echo "verbose is set to ${{ inputs.verbose }} "
        ##


    - name: Login with a GitHub Token
      id: gh-user-auth
      # switch to this #if: ${{ steps.pr-from-commit.outputs.result && inputs.account-type=='user' }}
      if: inputs.account-type=='user'
      # references:
      #  # https://cli.github.com/manual/gh_auth_login
      #  # https://josh-ops.com/posts/gh-auth-login-in-actions/
      #  # https://stackoverflow.com/questions/75968833/does-gh-auth-login-create-a-github-token-or-gh-token
      env:
        # use GH_TOKEN per https://josh-ops.com/posts/gh-auth-login-in-actions/
        #bot#GH_TOKEN: ${{ inputs.gh-app-key }}
        #user#GH_TOKEN: ${{ inputs.gh-token }}
        GH_TOKEN: ${{ inputs.gh-token }}
      run: |
        echo "Login with the user actions token "
        echo ${{ secrets.BOT_USER_ACTIONS_TOKEN }} | gh auth login --with-token
        echo ""
        echo "Check the GitHub authentication status "
        gh auth status
        echo ""
      shell: bash


    - name: Create a GitHub App Token
      # Verified creator: https://github.com/marketplace/actions/create-github-app-token
      # GitHub Action for creating a GitHub App installation access token.
      uses: actions/create-github-app-token@21cfef2b496dd8ef5b904c159339626a10ad380e # v1.11.6
      id: app-token
      #if: ${{ steps.pr-from-commit.outputs.result && fromJson(steps.pr-from-commit.outputs.result).number }}
      # this worked when we were using the 'bot' for authentication
      if: inputs.account-type=='bot'
      #if: ${{ steps.pr-from-commit.outputs.result && fromJson(steps.pr-from-commit.outputs.result).number && inputs.account-type=='bot' }}
      with:
        # required
        app-id: ${{ secrets.GH_APP_ID }}
        private-key: ${{ inputs.gh-app-key }}
        # create a token for all repositories in the current owner's installation
        # https://github.com/actions/create-github-app-token#create-a-token-for-all-repositories-in-the-current-owners-installation
        owner: ${{ github.repository_owner }}


    - name: Output variables from this job to the action output
      # Output variables for the action
      id: set-vars-output
      shell: bash
      run: |
        echo "EXAMPLE_ACTION_OUTPUT1=${EXAMPLE_ACTION_OUTPUT1}" >> "$GITHUB_OUTPUT"
