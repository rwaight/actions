name: 'Get Next Semver'
description: 'Get the next semantic version'
author: 'rwaight'
branding:
  icon: 'info'
  color: 'blue'
  # Ref: https://haya14busa.github.io/github-action-brandings/
  # fork: https://github.com/rwaight/github-action-brandings

inputs:
  gh-token:
    description: 'GITHUB_TOKEN or a `repo` scoped Personal Access Token (PAT), may be needed for the GitHub CLI. '
    required: true
    default: ${{ github.token }}
  pre-release-id:
    description: 'Pre-release identifier (only for pre-release builds). The only supported pre-release syntax is "rc" at this time. '
    required: false
    default: 'rc'
    # should consider adding 'premajor', 'preminor', and 'prepatch' in the future
  release-type:
    description: 'The release type, should be one of: major, minor, patch, or prerelease. The only supported pre-release syntax is "rc" at this time. '
    required: true
    default: 'not-set'
    # should consider adding 'premajor', 'preminor', and 'prepatch' in the future
  my_action_debug:
    description: 'Determine if the workflow should run debug tasks, defaults to false. '
    required: false
    default: 'false'

outputs:
  current-release-version:
    description: "The current release version in the repo. "
    value: ${{ steps.get-current-release.outputs.current-release-version }}
  next-release-version:
    description: "The next release version in the repo. "
    value: ${{ steps.set-next-release.outputs.next-release-version }}


runs:
  using: "composite"
  # Ref: https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
  steps:
    - name: Validate that the runner OS is Linux
      if: ${{ runner.os != 'Linux' }}
      shell: bash
      run: |
        echo "::error title=⛔ error::This action supports Linux only"
        exit 1

    - name: Greet the triggering_actor
      if: inputs.my_action_debug=='true'
      shell: bash
      run: echo Hello ${{ github.triggering_actor }}, the my_action_debug variable is set to true.

    - name: Debug | Print the release-type
      #if: inputs.my_action_debug=='true'
      id: debug-print-release-type
      shell: bash
      run: | 
        ## Print the inputs if inputs.my_action_debug=='true'
        ## the double number signs below are for line spacing and readability only
        ##
        echo "starting the 'debug-print-release-type' step. "
        echo ""
        echo "release-type is   :  ${{ inputs.release-type }} "
        ##
        echo "completing the 'debug-print-release-type' step. "

    - name: Validate the release-type input
      id: validate-input-release-type-0
      if: ${{ !contains(fromJSON('["major", "minor", "patch", "pre"]'), inputs.release-type) }}
      shell: bash
      run: |
        echo "::error title=⛔ validate-input-release-type-0,hint::Invalid 'release-type', must be one of: major, minor, patch, premajor, preminor, prepatch, or prerelease"
        #exit 1

    - name: Validate the release-type input
      # https://github.com/orgs/community/discussions/25252#discussioncomment-3247116
      id: validate-input-release-type-1
      if: |
        contains('pre', inputs.release-type) ||
        contains('major', inputs.release-type) ||
        contains('minor', inputs.release-type) ||
        contains('patch', inputs.release-type)
      shell: bash
      run: |
        echo "::notice title=validate-input-release-type-1::The 'release-type' is valid."

    - name: Validate the release-type input
      # https://github.com/orgs/community/discussions/25252#discussioncomment-3247116
      id: validate-input-release-type-2
      if: ${{ !contains(fromJSON('["major", "minor", "patch", "pre"]'), inputs.release-type) }}
      # the below if statement does not work
      # if: | 
      #   ${{ !contains(inputs.release-type, 'major') }} || 
      #   ${{ !contains(inputs.release-type, 'minor') }} || 
      #   ${{ !contains(inputs.release-type, 'patch') }} || 
      #   ${{ !contains(inputs.release-type, 'pre') }}
      shell: bash
      run: |
        echo "::error title=⛔ validate-input-release-type-2::Invalid 'release-type', must be one of: major, minor, patch, premajor, preminor, prepatch, or prerelease"
        #exit 1

    - name: Debug | Print the inputs
      if: inputs.my_action_debug=='true'
      id: debug-print-inputs
      shell: bash
      run: | 
        ## Print the inputs if inputs.my_action_debug=='true'
        ## the double number signs below are for line spacing and readability only
        ##
        echo "starting the 'debug-print-inputs' step. "
        echo ""
        echo "pre-release-id is :  ${{ inputs.pre-release-id }} "
        echo "release-type is   :  ${{ inputs.release-type }} "
        echo "my_action_debug is:  ${{ inputs.my_action_debug }} "
        ##
        echo "completing the 'debug-print-inputs' step. "

    - name: Get the current release version
      id: get-current-release
      shell: bash
      run: |
        ## Get the current release version
        ## the double number signs below are for line spacing and readability only
        ##
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "starting the 'get-current-release' step. "
            echo ""
            echo "Using the GitHub CLI to print release information"
            echo "See https://cli.github.com/manual/gh_release_list for information about the command. "
            echo ""
            echo "Debug enabled, running additional 'gh release' commands"
            echo ""
            echo "::group::running 'gh release list' ... "
            gh release list
            echo "::endgroup::"
            echo ""
            echo "::group::running 'gh release list --exclude-drafts' ... "
            gh release list --exclude-drafts
            echo "::endgroup::"
            echo ""
            echo "::group::running 'gh release list --exclude-drafts --exclude-pre-releases' ... "
            gh release list --exclude-drafts --exclude-pre-releases
            echo "::endgroup::"
            echo ""
            echo "::group::running 'gh release list --exclude-drafts --exclude-pre-releases --limit 1' ... "
            gh release list --exclude-drafts --exclude-pre-releases --limit 1
            echo "::endgroup::"
            echo ""
            echo "::group::running 'gh release list --exclude-drafts --exclude-pre-releases --limit 1 --json tagName | jq -r \".[].tagName\"' ... "
            gh release list --exclude-drafts --exclude-pre-releases --limit 1 --json tagName | jq -r ".[].tagName"
            echo "::endgroup::"
            echo ""
            echo "To learn more about using the GitHub CLI with workflows... "
            echo "See https://docs.github.com/en/actions/using-workflows/using-github-cli-in-workflows "
            echo ""
        fi
        ##
        if [ '${{ inputs.release-type }}' == 'prerelease' ]; then
            echo "capturing the latest pre-release from the GitHub CLI, as the 'release-type' is 'prerelease'. "
            current_release_version=$(gh release list --exclude-drafts --limit 1 --json tagName | jq -r ".[].tagName")
        elif [[ "${{ inputs.release-type }}" == "pre"* ]]; then
            echo "capturing the latest premajor/preminor/prepatch from the GitHub CLI, as the 'release-type' is one of 'premajor/preminor/prepatch'. "
            current_release_version=$(gh release list --exclude-drafts --limit 1 --json tagName | jq -r ".[].tagName")
            # https://stackoverflow.com/questions/229551/how-to-check-if-a-string-contains-a-substring-in-bash
        else
            echo "capturing the latest (current) release from the GitHub CLI "
            current_release_version=$(gh release list --exclude-drafts --exclude-pre-releases --limit 1 --json tagName | jq -r ".[].tagName")
        fi
        ##
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "current_release_version: $current_release_version"
            echo "writing the 'current_release_version' to the environment and GitHub output"
        fi
        echo "current_release_version=${current_release_version}" >> "$GITHUB_OUTPUT"
        echo "current_release_version=${current_release_version}" >> $GITHUB_ENV
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "The current release version of this repo is \`$current_release_version\`"
            echo "writing $current_release_version to the 'current-release-version' GitHub output"
        fi
        echo "current-release-version=${current_release_version}" >> "$GITHUB_OUTPUT"
        echo "current-release-version=${current_release_version}" >> $GITHUB_ENV
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then echo "completing the 'get-current-release' step. "; fi
      env:
        GH_TOKEN: ${{ inputs.gh-token }}

    - name: Set the next release version
      id: set-next-release
      shell: bash
      run: |
        ## Set the next release version
        ## the double number signs below are for line spacing and readability only
        ##
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "starting the 'set-next-release' step. "
            echo "current_release_version is:  ${{ env.current_release_version }} "
            echo "pre-release-id is         :  ${{ inputs.pre-release-id }} "
            echo "release-type is           :  ${{ inputs.release-type }} "
            echo ""
            echo "::group::printing the syntax to bump '${{ inputs.release-type }}' ... "
            if [ '${{ inputs.release-type }}' == 'prerelease' ]; then
                ## echo "$version" | awk 'BEGIN{FS=OFS="-rc"} {$2+=1} 1'
                ## echo "$version" | awk 'BEGIN{FS=OFS="-${{ inputs.release-type }}"} {$2+=1} 1'
                echo "the syntax to bump 'prerelease' is: "
                ###echo "echo \"\$version\" | awk 'BEGIN{FS=OFS=\"-rc\"} {\$2+=1} 1'"
                echo "echo \"\$version\" | awk 'BEGIN{FS=OFS=\"-${{ inputs.pre-release-id }}\"} {\$2+=1} 1'"
            elif [ '${{ inputs.release-type }}' == 'patch' ]; then
                ## echo "$version" | awk 'BEGIN{FS=OFS="."} {$3+=1} 1'
                echo "the syntax to bump 'patch' is: "
                echo "echo \"\$version\" | awk 'BEGIN{FS=OFS=\".\"} {\$3+=1} 1'"
            elif [ '${{ inputs.release-type }}' == 'minor' ]; then
                ## echo "$version" | awk 'BEGIN{FS=OFS="."} {$2+=1;$3=0} 1'
                echo "the syntax to bump 'minor' is: "
                echo "echo \"\$version\" | awk 'BEGIN{FS=OFS=\".\"} {\$2+=1;\$3=0} 1'"
            elif [ '${{ inputs.release-type }}' == 'major' ]; then
                ## echo "$version" | awk 'BEGIN{FS=OFS="."} {$1+=1;$2=0;$3=0} 1'
                echo "the syntax to bump 'major' is: "
                echo "echo \"\$version\" | awk 'BEGIN{FS=OFS=\".\"} {\$1+=1;\$2=0;\$3=0} 1'"
            else
                echo "something is wrong with a conditional. "
                echo "this is the DEBUG 'else' statement in the 'set-next-release' step. "
            fi
            echo "::endgroup::"
        fi
        ##
        if [ '${{ inputs.release-type }}' == 'prerelease' ]; then
            echo "updating the next rc-version for a prerelease. "
            next_release_version=$(echo "$current_release_version" | awk 'BEGIN{FS=OFS="-${{ inputs.pre-release-id }}"} {$2+=1} 1')
            ##next_release_version=$(echo "$current_release_version" | awk 'BEGIN{FS=OFS="-rc"} {$2+=1} 1')
            ##
        elif [ '${{ inputs.release-type }}' == 'patch' ]; then
            echo "updating the next-version for a patch release. "
            next_release_version=$(echo "$current_release_version" | awk 'BEGIN{FS=OFS="."} {$3+=1} 1')
            ##
        elif [ '${{ inputs.release-type }}' == 'minor' ]; then
            echo "updating the next-version for a minor release. "
            next_release_version=$(echo "$current_release_version" | awk 'BEGIN{FS=OFS="."} {$2+=1;$3=0} 1')
            ##
        elif [ '${{ inputs.release-type }}' == 'major' ]; then
            echo "updating the next-version for a major release. "
            next_release_version=$(echo "$current_release_version" | awk 'BEGIN{FS=OFS="."} {$1+=1;$2=0;$3=0} 1')
            ##
        else
            echo "something is wrong with a conditional, incrementing the version as a PATCH release.. "
            next_release_version=$(echo "$current_release_version" | awk 'BEGIN{FS=OFS="."} {$3+=1} 1')
        fi
        echo "next_release_version=${next_release_version}" >> "$GITHUB_OUTPUT"
        echo "next_release_version=${next_release_version}" >> $GITHUB_ENV
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "The next release version has been set to \`$next_release_version\`"
            echo "writing $next_release_version to the 'next-release-version' GitHub output"
        fi
        echo "next-release-version=${next_release_version}" >> "$GITHUB_OUTPUT"
        echo "next-release-version=${next_release_version}" >> $GITHUB_ENV
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then echo "completing the 'set-next-release' step. "; fi
      env:
        current_release_version: ${{ steps.get-current-release.outputs.current-release-version }}
        ## Increment a PRERELEASE '-rc' version:
        ## echo "$version" | awk 'BEGIN{FS=OFS="-rc"} {$2+=1} 1'
        ## Increment a PATCH version:
        ## echo "$version" | awk 'BEGIN{FS=OFS="."} {$3+=1} 1'
        ## Increment a MINOR version:
        ## echo "$version" | awk 'BEGIN{FS=OFS="."} {$2+=1;$3=0} 1'
        ## Increment a MAJOR version:
        ## echo "$version" | awk 'BEGIN{FS=OFS="."} {$1+=1;$2=0;$3=0} 1'

    - name: Validate the next release version
      id: validate-next-release
      shell: bash
      run: |
        ## Validate the next release version
        ## the double number signs below are for line spacing and readability only
        ##
        VERSION="${{ env.next_release_version }}"
        ##
        RE='^[vV]?([0-9]+)[.]([0-9]+)[.]([0-9]+)(-[0-9A-Za-z.+-]*)?'
        if [[ $VERSION =~ $RE ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PRERELEASE="${BASH_REMATCH[4]}"
            if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
                echo "VERSION is: $VERSION "
                echo "RE is     : $RE "
                echo "MAJOR is  : $MAJOR "
                echo "MINOR is  : $MINOR "
                echo "PATCH is  : $PATCH "
                echo "PRERELEASE: $PRERELEASE"
            fi
        else
            ## Fail the workflow if the 'next-release-version' is not valid
            echo "::error::Next release version '$VERSION' is not in a valid format"
            exit 1
        fi
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then echo "completing the 'validate-next-release' step. "; fi
      env:
        next_release_version: ${{ steps.set-next-release.outputs.next-release-version }}

    - name: Compare the current release version to the next release version
      id: compare-current-to-next-release
      shell: bash
      run: |
        ## Compare the current release version to the next release version
        ## the double number signs below are for line spacing and readability only
        ##
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "starting the 'compare-current-to-next-release' step. "
            echo "current_release_version is:  ${{ env.current_release_version }} "
            echo "next_release_version is   :  ${{ env.next_release_version }} "
        fi
        ##
        if [ '${{ env.current_release_version }}' == '${{ env.next_release_version }}' ]; then
            echo "the 'current_release_version' is set to '${{ env.current_release_version }}' and matches "
            echo "  the 'next_release_version' which is set to '${{ env.next_release_version }}'. "
            current_and_next_match=true
        else
            echo "the 'current_release_version' is set to '${{ env.current_release_version }}' and DOES NOT MATCH "
            echo "  the 'next_release_version' which is set to '${{ env.next_release_version }}'. "
            current_and_next_match=false
        fi
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "setting the value of 'does_current_match_next' to '${current_and_next_match}' and sending it to GitHub output"
        fi
        echo "does_current_match_next=${current_and_next_match}" >> "$GITHUB_OUTPUT"
        echo "does_current_match_next=${current_and_next_match}" >> $GITHUB_ENV
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "The does_current_match_next variable has been set to \`$current_and_next_match\`"
            echo "writing $current_and_next_match to the 'does-current-match-next' GitHub output"
        fi
        echo "does-current-match-next=${current_and_next_match}" >> "$GITHUB_OUTPUT"
        echo "does-current-match-next=${current_and_next_match}" >> $GITHUB_ENV
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then echo "completing the 'compare-current-to-next-release' step. "; fi
      env:
        current_release_version: ${{ steps.get-current-release.outputs.current-release-version }}
        next_release_version: ${{ steps.set-next-release.outputs.next-release-version }}

    # - name: Error if the current version matches the next version
    #   id: error-matched-versions
    #   if: ( ${{ steps.compare-current-to-next-release.outputs.does-current-match-next }} == 'true' )
    #   #not working properly#if: ${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}
    #   #not working properly#if: ( '${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}' == 'true' )
    #   shell: bash
    #   run: |
    #     ## Error if the current version matches the next version
    #     ## the double number signs below are for line spacing and readability only
    #     ##
    #     if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
    #         echo "starting the 'error-matched-versions' step. "
    #         echo "does-current-match-next is:  ${{ env.does-current-match-next }} "
    #         echo "current-release-version is:  ${{ env.current-release-version }} "
    #         echo "next-release-version is   :  ${{ env.next-release-version }} "
    #     fi
    #     echo "::error title=⛔ matched versions error::The current version matches the next version"
    #     exit 1
    #     if [ '${{ inputs.my_action_debug }}' == 'true' ]; then echo "completing the 'error-matched-versions' step. "; fi
    #   env: 
    #     current-release-version: ${{ steps.get-current-release.outputs.current-release-version }}
    #     next-release-version: ${{ steps.set-next-release.outputs.next-release-version }}
    #     does-current-match-next: ${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}

    - name: Validate that the current version does not match the next version
      id: validate-version-not-matched
      #if: ( ${{ steps.compare-current-to-next-release.outputs.does-current-match-next }} != 'true' )
      #not working properly#if: ${{ steps.compare-current-to-next-release.outputs.does-current-match-next }} != 'true'
      #not working properly#if: ( '${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}' != 'true' )
      shell: bash
      run: |
        ## Validate that the current version does not match the next version
        ## the double number signs below are for line spacing and readability only
        ##
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then
            echo "starting the 'validate-version-not-matched' step. "
            echo "does-current-match-next is:  ${{ env.does-current-match-next }} "
            echo "current-release-version is:  ${{ env.current-release-version }} "
            echo "next-release-version is   :  ${{ env.next-release-version }} "
        fi
        ##
        if [ '${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}' == 'false' ]; then
            echo "Excellent, the current version does not match the next version. "
            echo "::notice title=validate-version-not-matched::Excellent, the current version does not match the next version."
        elif [ '${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}' == 'true' ]; then
            echo "Uh oh! The current version matches the next version! "
            echo "::error title=⛔ matched versions error::The current version matches the next version"
            exit 1
        else
            echo "::notice title=validate-version-not-matched::something strange is happening, this is the else statement of validate-version-not-matched."
        fi
        ##
        if [ '${{ inputs.my_action_debug }}' == 'true' ]; then echo "completing the 'validate-version-not-matched' step. "; fi
      env: 
        current-release-version: ${{ steps.get-current-release.outputs.current-release-version }}
        next-release-version: ${{ steps.set-next-release.outputs.next-release-version }}
        does-current-match-next: ${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}

    - name: Debug | Print the outputs
      if: inputs.my_action_debug=='true'
      id: debug-print-outputs
      shell: bash
      run: | 
        ## Print the outputs if inputs.my_action_debug=='true'
        ## the double number signs below are for line spacing and readability only
        ##
        echo "starting the 'debug-print-outputs' step. "
        echo ""
        echo "Current release version information: "
        echo "current-release-version is:  ${{ env.current-release-version }} "
        echo ""
        echo "Next release version information: "
        echo "next-release-version is:  ${{ env.next-release-version }} "
        echo ""
        echo "Version match results: "
        echo "does-current-match-next is:  ${{ env.does-current-match-next }} "
        echo ""
        ##
        echo "completing the 'debug-print-outputs' step. "
      env:
        current-release-version: ${{ steps.get-current-release.outputs.current-release-version }}
        next-release-version: ${{ steps.set-next-release.outputs.next-release-version }}
        does-current-match-next: ${{ steps.compare-current-to-next-release.outputs.does-current-match-next }}
